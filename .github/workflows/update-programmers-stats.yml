name: Update Programmers Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # 6시간마다 실행
  workflow_dispatch:  # 수동 실행 가능
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count solved problems
        id: count
        run: |
          # 프로그래머스 웹사이트에서 실제 해결한 문제 수 가져오기
          # 웹사이트 HTML에서 "푼 문제" 통계 추출
          HTML=$(curl -s "https://programmers.co.kr/users/challenge-activity" || echo "")
          
          # "푼 문제" 다음에 나오는 숫자 추출 (예: "5개")
          COUNT=$(echo "$HTML" | grep -oP '푼 문제[^<]*>\s*(\d+)개' | grep -oP '\d+' | head -1 || echo "0")
          
          # 만약 웹 스크래핑이 실패하면 GitHub 레포지토리에서 카운트
          if [ -z "$COUNT" ] || [ "$COUNT" = "0" ]; then
            git clone --depth 1 https://github.com/hywznn/programmers.git temp-repo 2>/dev/null || true
            if [ -d "temp-repo" ]; then
              COUNT=$(find temp-repo -name "*.js" -type f | grep -v node_modules | wc -l)
              rm -rf temp-repo
            else
              COUNT="5"  # 기본값 (웹사이트에 표시된 수)
            fi
          fi
          
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Solved problems: $COUNT"

      - name: Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');
            const count = '${{ steps.count.outputs.count }}';
            
            // 프로그래머스 배지 패턴 찾기 및 업데이트
            const badgePattern = /\[!\[Programmers\][^\]]+\]\([^)]+\)/;
            const newBadge = `[![Programmers](https://img.shields.io/badge/Programmers-${count}%20solved-1E8E3E?style=flat-square&logo=Programmers&logoColor=white)](https://programmers.co.kr/profiles/choihj0510)`;
            
            if (badgePattern.test(readme)) {
              readme = readme.replace(badgePattern, newBadge);
            } else {
              console.log('Programmers badge pattern not found');
            }
            
            console.log(`Updated count: ${count}`);
            
            fs.writeFileSync('README.md', readme);

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || (git commit -m "Update programmers solved count" && git push)

