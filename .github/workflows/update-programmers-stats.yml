name: Update Programmers Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # 6시간마다 실행
  workflow_dispatch:  # 수동 실행 가능
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count solved problems
        id: count
        run: |
          # 프로그래머스 레포지토리 클론하여 .js 파일 수 카운트
          git clone --depth 1 https://github.com/hywznn/programmers.git temp-repo || exit 1
          COUNT=$(find temp-repo -name "*.js" -type f | grep -v node_modules | wc -l)
          rm -rf temp-repo
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Solved problems: $COUNT"

      - name: Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');
            const count = '${{ steps.count.outputs.count }}';
            
            // 프로그래머스 배지 패턴 찾기 및 업데이트
            const badgePattern = /\[!\[Programmers\][^\]]+\]\([^)]+\)/;
            const newBadge = `[![Programmers](https://img.shields.io/badge/Programmers-${count}%20solved-1E8E3E?style=flat-square&logo=Programmers&logoColor=white)](https://programmers.co.kr/profiles/choihj0510)`;
            
            if (badgePattern.test(readme)) {
              readme = readme.replace(badgePattern, newBadge);
            } else {
              console.log('Programmers badge pattern not found');
            }
            
            console.log(`Updated count: ${count}`);
            
            fs.writeFileSync('README.md', readme);

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || (git commit -m "Update programmers solved count" && git push)

