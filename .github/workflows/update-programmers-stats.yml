name: Update Programmers Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # 6시간마다 실행
  workflow_dispatch:  # 수동 실행 가능
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count solved problems
        id: count
        run: |
          # 프로그래머스 레포지토리에서 .js 파일 수 카운트
          COUNT=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/hywznn/programmers/git/trees/main?recursive=1" | \
            grep -o '"path": "[^"]*\.js"' | wc -l || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Solved problems: $COUNT"

      - name: Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');
            const count = '${{ steps.count.outputs.count }}';
            
            // 프로그래머스 배지 패턴 찾기 및 업데이트
            const badgePattern = /\[!\[Programmers\][^\]]+\]\([^)]+\)/;
            const newBadge = `[![Programmers](https://img.shields.io/badge/Programmers-${count}%20solved-1E8E3E?style=flat-square&logo=Programmers&logoColor=white)](https://programmers.co.kr/profiles/hywznn)`;
            
            if (badgePattern.test(readme)) {
              readme = readme.replace(badgePattern, newBadge);
            }
            
            fs.writeFileSync('README.md', readme);

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || (git commit -m "Update programmers solved count" && git push)

